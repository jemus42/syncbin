#! /usr/bin/env Rscript --vanilla

args <- commandArgs(TRUE)

if (length(args) == 0) {
	cat("timesheet <start (hh:mm)> <end (hh:mm)> <breaks (hh:mm | mm)>\n")
	cat("Example: timesheet 9:00 18:00 30\n")
	quit()
}

# print(args)

as_hour <- function(x) as.numeric(x/lubridate::dhours(1))
as_mins <- function(x) as.numeric(x/lubridate::dminutes(1))

as_hm <- function(x) {
  if (!stringi::stri_detect(as.character(x), regex = ":")) return(hms::hms(minutes = as.numeric(x)))
  hms::as_hms(paste0(x, ":00"))
}

timesheet <- function(start, stop, breaks) {

  start <- as_hm(start)
  stop <- as_hm(stop)
  breaks <- as_hm(breaks)

  total <- lubridate::as.duration(stop - start)

  total_ist <- total - lubridate::as.duration(breaks)
  bips_ist <- total_ist / 2
  bips_breaks <- total - bips_ist

  fmt_total <- round(as_hour(total), 2)
  fmt_breaks <- cli::col_br_red(as_mins(breaks))
  fmt_total_ist <- cli::col_br_blue(round(as_hour(total_ist), 2))
  #fmt_bips_ist <- cli::col_green(round(as_hour(bips_ist), 2))
  fmt_bips_ist <- cli::col_green(ceiling(as_hour(bips_ist) * 100) / 100)
  fmt_bips_break <- cli::col_br_cyan(round(as_hour(bips_breaks), 2))

  overunder <- round(as_hour(bips_ist) - 4, 2)
  fmt_overunder <- ifelse(
    overunder < 0,
    cli::col_br_red(overunder),
    cli::col_br_green(overunder)
  )

  cli::cli_h1("Timesheet summary")

  cli::cli_ul()
  cli::cli_li("{.emph {fmt_total}h} timespan with {.emph {fmt_breaks}min} break")
  cli::cli_li("Effective work time: {.emph {fmt_total_ist}h}")
  cli::cli_end()

  cli::cli_h2("For BIPS sheet")

  cli::cli_ul()
  cli::cli_li("'Ist' : {.emph {fmt_bips_ist}h} ({fmt_overunder})")
  cli::cli_li("'Pausen' : {.emph {fmt_bips_break}}")
  cli::cli_end()

}

timesheet(
  start = args[[1]],
  stop = args[[2]],
  breaks = args[[3]]
)
