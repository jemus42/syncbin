#!/bin/sh
# syncbin-doctor - Health check for syncbin dotfiles setup
# Run this to verify your syncbin installation is working correctly

# Don't exit on errors - we want to run all checks
set +e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
DIM='\033[2m'
NC='\033[0m'

# Counters
ERRORS=0
WARNINGS=0

# Define SYNCBIN
SYNCBIN="${SYNCBIN:-$HOME/syncbin}"

# Detect OS
case "$(uname -s)" in
    Darwin) OS_TYPE="macos" ;;
    Linux)  OS_TYPE="linux" ;;
    *)      OS_TYPE="unknown" ;;
esac

# Helper functions
print_header() {
    printf "\n${BLUE}%s${NC}\n" "$1"
    printf "${DIM}%s${NC}\n" "$(echo "$1" | sed 's/./-/g')"
}

check_ok() {
    printf "${GREEN}  ✓${NC} %s\n" "$1"
}

check_warn() {
    printf "${YELLOW}  ⚠${NC} %s\n" "$1"
    WARNINGS=$((WARNINGS + 1))
}

check_err() {
    printf "${RED}  ✗${NC} %s\n" "$1"
    ERRORS=$((ERRORS + 1))
}

check_info() {
    printf "${DIM}  ○${NC} %s\n" "$1"
}

# Check if a command exists
has_cmd() {
    command -v "$1" >/dev/null 2>&1
}

# Check if a symlink points to expected target
check_symlink() {
    local link="$1"
    local expected="$2"
    local name="$3"

    if [ ! -e "$link" ] && [ ! -L "$link" ]; then
        check_err "$name: missing ($link)"
        return 1
    elif [ -L "$link" ]; then
        local target
        target=$(readlink "$link")
        if [ "$target" = "$expected" ]; then
            check_ok "$name"
            return 0
        else
            check_warn "$name: points to $target (expected $expected)"
            return 1
        fi
    else
        check_warn "$name: exists but is not a symlink"
        return 1
    fi
}

# Start
printf "${BLUE}======================================${NC}\n"
printf "${BLUE}     Syncbin Doctor                   ${NC}\n"
printf "${BLUE}======================================${NC}\n"
printf "\n"
printf "SYNCBIN: %s\n" "$SYNCBIN"
printf "OS: %s\n" "$OS_TYPE"
printf "Shell: %s\n" "$SHELL"

#########################
## Core Checks
#########################
print_header "Core Setup"

# Check SYNCBIN exists
if [ -d "$SYNCBIN" ]; then
    check_ok "SYNCBIN directory exists"
else
    check_err "SYNCBIN directory missing: $SYNCBIN"
fi

# Check it's a git repo
if [ -d "$SYNCBIN/.git" ]; then
    check_ok "Git repository initialized"
    # Check for uncommitted changes
    if git -C "$SYNCBIN" diff --quiet 2>/dev/null; then
        check_ok "No uncommitted changes"
    else
        check_info "Uncommitted changes present"
    fi
else
    check_warn "Not a git repository"
fi

# Check submodules
if [ -f "$SYNCBIN/.gitmodules" ]; then
    submodule_count=$(git -C "$SYNCBIN" submodule status 2>/dev/null | wc -l | tr -d ' ')
    initialized=$(git -C "$SYNCBIN" submodule status 2>/dev/null | grep -cv '^-' | tr -d ' ' || echo "0")
    if [ "$initialized" = "$submodule_count" ]; then
        check_ok "Git submodules initialized ($submodule_count)"
    else
        check_warn "Some submodules not initialized ($initialized/$submodule_count)"
    fi
fi

#########################
## Shell Configs
#########################
print_header "Shell Configuration Symlinks"

check_symlink "$HOME/.zshrc" "$SYNCBIN/zsh/zshrc.zsh" "ZSH config (~/.zshrc)"
check_symlink "$HOME/.bashrc" "$SYNCBIN/bash/bashrc" "Bash config (~/.bashrc)"
check_symlink "$HOME/.bash_profile" "$SYNCBIN/bash/bash_profile" "Bash profile (~/.bash_profile)"
check_symlink "$HOME/.config/fish/config.fish" "$SYNCBIN/fish/config.fish" "Fish config"

#########################
## Oh-My-Zsh
#########################
print_header "Oh-My-Zsh"

if [ -d "$HOME/.oh-my-zsh" ]; then
    check_ok "Oh-My-Zsh installed"

    # Check custom directory
    ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
    if [ -d "$SYNCBIN/ohmyzsh_custom/plugins" ]; then
        plugin_count=$(find "$SYNCBIN/ohmyzsh_custom/plugins" -maxdepth 1 -type d | wc -l)
        check_ok "Custom plugins available ($((plugin_count - 1)))"
    fi
else
    check_warn "Oh-My-Zsh not installed"
fi

#########################
## Required Dependencies
#########################
print_header "Required Dependencies"

if has_cmd git; then
    check_ok "git $(git --version | cut -d' ' -f3)"
else
    check_err "git not found"
fi

#########################
## Optional Dependencies
#########################
print_header "Optional Dependencies"

# Completion system
if has_cmd carapace; then
    version=$(carapace --version 2>/dev/null | head -1 || echo "unknown")
    check_ok "carapace $version"

    # Check carapace specs directory
    if [ -d "$HOME/.config/carapace/specs" ]; then
        spec_count=$(find "$HOME/.config/carapace/specs" -name "*.yaml" 2>/dev/null | wc -l | tr -d ' ')
        if [ "$spec_count" -gt 0 ]; then
            check_ok "carapace custom specs ($spec_count)"
        else
            check_info "No custom carapace specs"
        fi
    fi
else
    check_info "carapace not installed (completions will use fallback)"
fi

# Prompt
if has_cmd starship; then
    check_ok "starship $(starship --version | head -1 | cut -d' ' -f2)"
else
    check_info "starship not installed"
fi

# Modern CLI tools
for tool in bat lsd ripgrep fd fzf zoxide eza; do
    cmd="$tool"
    # Handle command name differences
    case "$tool" in
        ripgrep) cmd="rg" ;;
    esac

    if has_cmd "$cmd"; then
        check_ok "$tool"
    else
        check_info "$tool not installed"
    fi
done

# Development tools
for tool in tmux direnv; do
    if has_cmd "$tool"; then
        check_ok "$tool"
    else
        check_info "$tool not installed"
    fi
done

#########################
## Config Files
#########################
print_header "Configuration Files"

configs="
$HOME/.config/starship.toml:Starship config
$HOME/.config/bat/config:Bat config
$HOME/.config/btop/btop.conf:Btop config
$HOME/.config/tmux/tmux.conf:Tmux config
"

echo "$configs" | while IFS=: read -r path name; do
    [ -z "$path" ] && continue
    if [ -e "$path" ] || [ -L "$path" ]; then
        if [ -L "$path" ]; then
            check_ok "$name (symlinked)"
        else
            check_info "$name (local file)"
        fi
    else
        check_info "$name not present"
    fi
done

#########################
## Completions
#########################
print_header "Shell Completions"

# ZSH completions
zsh_comp_dir="$SYNCBIN/zsh/completions"
if [ -d "$zsh_comp_dir" ]; then
    zsh_comp_count=$(find "$zsh_comp_dir" -name "_*" -type f 2>/dev/null | wc -l | tr -d ' ')
    check_ok "ZSH custom completions ($zsh_comp_count)"
else
    check_info "No ZSH custom completions directory"
fi

# Bash completions
bash_comp_dir="$SYNCBIN/bash/completions"
if [ -d "$bash_comp_dir" ]; then
    bash_comp_count=$(find "$bash_comp_dir" -name "*.bash" -type f 2>/dev/null | wc -l | tr -d ' ')
    check_ok "Bash custom completions ($bash_comp_count)"
else
    check_info "No Bash custom completions directory"
fi

# Fish completions
fish_comp_dir="$SYNCBIN/fish/completions"
if [ -d "$fish_comp_dir" ]; then
    fish_comp_count=$(find "$fish_comp_dir" -name "*.fish" -type f 2>/dev/null | wc -l | tr -d ' ')
    check_ok "Fish custom completions ($fish_comp_count)"
else
    check_info "No Fish custom completions directory"
fi

#########################
## Summary
#########################
printf "\n${BLUE}======================================${NC}\n"

if [ "$ERRORS" -eq 0 ] && [ "$WARNINGS" -eq 0 ]; then
    printf "${GREEN}All checks passed!${NC}\n"
    exit 0
elif [ "$ERRORS" -eq 0 ]; then
    printf "${YELLOW}%d warning(s), no errors${NC}\n" "$WARNINGS"
    exit 0
else
    printf "${RED}%d error(s), %d warning(s)${NC}\n" "$ERRORS" "$WARNINGS"
    printf "\nRun ${BLUE}%s/install.sh${NC} to fix issues.\n" "$SYNCBIN"
    exit 1
fi
